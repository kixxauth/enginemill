<!DOCTYPE html>

<html>
<head>
  <title>Enginemill</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="enginemill">Enginemill</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Enginemill is a Node.js web development framework. The goal is to codify
some opinions about how to structure a Node.js system and provide
tools to make the development of your systems easier and more fun.</p>
<ul>
<li><a href="https://github.com/petkaantonov/bluebird">Bluebird</a> for Promises.</li>
<li><a href="https://lodash.com/">Lodash</a> (Underscore) too.</li>
<li><a href="https://github.com/kixxauth/filepath">Filepath</a> to work with the filesystem.</li>
<li><a href="https://github.com/bcoe/yargs">Yargs</a> to parse command line options.</li>
<li><a href="http://momentjs.com/">Moment</a> to parse, validate, manipulate and display dates.</li>
<li><a href="http://numeraljs.com/">Numeral</a> for Number formatting and manipulation.</li>
<li>An Object factory for composing mixins.</li>
<li>Serially load plugins you define and kicks off your app only when they have all loaded.</li>
<li>Comprehensive logging based on <a href="https://github.com/trentm/node-bunyan">Bunyan</a>.</li>
<li>Message and pattern based communication with <a href="https://github.com/oddnetworks/oddcast">Oddcast</a>.</li>
<li>Promisified <a href="https://github.com/request/request">request</a> wrapper for making HTTP requests.</li>
<li>Supports <a href="http://coffeescript.org/">CoffeeScript</a> out of the box, which is nice for config and plugin initialization files.</li>
</ul>
<p>This documentation is generated from <a href="https://github.com/kixxauth/enginemill">annotated source code</a> which you
can find on GitHub. Ideas, issues, and feedback is welcome on the
<a href="https://github.com/kixxauth/enginemill/issues">issue tracker</a>.</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Enginemill runs with <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode">strict mode</a> on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>The <code>exports</code> Object is assigned to <code>enginemill</code> for readability.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> enginemill = exports;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="dependencies">Dependencies</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3 id="private-dependencies">Private Dependencies</h3>
<p>Enginemill has some dependencies which are used internally, or exposed
elsewhere, but need to be loaded early.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span>
util         = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>),
EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>),
debug        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>),
nodeUUID     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-uuid'</span>),
REQ          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>),
Yargs        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'yargs'</span>),

sendDebug    = debug(<span class="hljs-string">'enginemill'</span>);

sendDebug(<span class="hljs-string">'Loading the Enginemill module.'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3 id="enginemill-promise">enginemill.Promise</h3>
<p>Enginemill uses <a href="http://bluebirdjs.com/docs/getting-started.html">Bluebird Promises</a> to handle asynchronous programming
from start to finish and exposes it as <code>enginemill.Promise</code> for you.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>enginemill.Promise = <span class="hljs-built_in">require</span>(<span class="hljs-string">'Bluebird'</span>);
<span class="hljs-keyword">var</span> <span class="hljs-built_in">Promise</span>        = enginemill.Promise;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3 id="enginemill-u">enginemill.U</h3>
<p>Enginemill also uses <a href="https://lodash.com/">Lodash</a> as the default JavaScript utility library,
and adds some extensions from <a href="https://github.com/kixxauth/brixx">BRIXX</a> as well. Notice that lodash is exported
as the <code>U</code> symbol instead of the <code>_</code> symbol. This is because the underscore
“_“ is used by many programmers to indicate a “private” symbol. Enginemill
holds the opinion that very rarely should anything be “private” in
JavaScript, but nevertheless, it’s usage is prevalent. Also, the “_“ is used
in the Node.js REPL to contain the value of the last executed statement.
Finally, the “U” symbol is appropriate for Lodash, since it is
commonly used in set theory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>enginemill.U = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>);
<span class="hljs-keyword">var</span> U     = enginemill.U;
<span class="hljs-keyword">var</span> BRIXX = <span class="hljs-built_in">require</span>(<span class="hljs-string">'brixx'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h3 id="lodash-extensions">Lodash Extensions</h3>
<h4 id="enginemill-u-ensure-">enginemill.U.ensure()</h4>
<p>Ensures the passed in object is, in fact, an Object. When <code>null</code> or
<code>undefined</code> are passed in, ensure() returns a new Object created with
<code>Object.create(null)</code>. Otherwise it returns the passed in Object.</p>
<h4 id="enginemill-u-deepfreeze-">enginemill.U.deepFreeze()</h4>
<p>Calls <code>Object.freeze()</code> recursively on the passed in Object. deepFreeze()
will skip the <code>arguemnts</code>, <code>caller</code>, <code>callee</code> and <code>prototype</code> properties
of a Function. deepFreeze() will throw if passed null or undefined just
like <code>Object.freeze()</code> would.</p>
<h4 id="enginemill-u-exists-">enginemill.U.exists()</h4>
<p>Check to see if the passed in Object exists. Returns false for null,
undefined, or NaN. Returns true for everything else.</p>
<h4 id="enginemill-u-stringify-">enginemill.U.stringify()</h4>
<p>A different way to stringify an Object, other than .toString():</p>
<ol>
<li>Returns an empty string for null, undefined or NaN.</li>
<li>Returns the special ‘[object Function]’ String for Functions.</li>
<li>Returns the result of .toString() if it exists.</li>
<li>Returns the result of Object.prototype.toString.</li>
</ol>
<h4 id="enginemill-u-factory-">enginemill.U.factory()</h4>
<p>An object factory which uses the mixin pattern. Returns a Function which
will create new Objects using a prototype composed of the mixins passed in.
See the <strong>Factories and Mixins</strong> section for more information.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>enginemill.U.mixin({
  ensure     : BRIXX.ensure,
  deepFreeze : BRIXX.deepFreeze,
  exists     : BRIXX.exists,
  stringify  : BRIXX.stringify,
  factory    : BRIXX.factory
});</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3 id="enginemill-filepath">enginemill.filepath</h3>
<p>Enginemill uses the <a href="https://github.com/kixxauth/filepath">FilePath</a> library as the default cross platform
interface for working with the file system in both posix and win32.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>enginemill.filepath = <span class="hljs-built_in">require</span>(<span class="hljs-string">'filepath'</span>);
<span class="hljs-keyword">var</span> filepath        = enginemill.filepath;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="error-handling">Error Handling</h2>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Enginemill makes robust exception handling
easy with <a href="http://bluebirdjs.com/docs/api/catch.html">Bluebird’s catch</a>,
allowing you to properly segment your exception handling based on
<a href="https://www.joyent.com/developers/node/design/errors">operational and programmer errors</a>.</p>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h3 id="enginemill-errors">enginemill.Errors</h3>
<p>The Standard Enginemill Error constructors are all exposed on <code>enginemill</code>
via the <code>Errors</code> namespace, allowing you to easily use them to handle
specific Error classes with <a href="http://bluebirdjs.com/docs/api/catch.html">Bluebird’s catch</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>enginemill.Errors = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
<span class="hljs-keyword">var</span> Errors        = enginemill.Errors;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h4 id="enginemill-errors-operationalerror">enginemill.Errors.OperationalError</h4>
<p>A superclass for all other Operational Errors and used by itself
as a general operational exception indicator.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">OperationalError</span>(<span class="hljs-params">message</span>) </span>{
  <span class="hljs-built_in">Error</span>.call(<span class="hljs-keyword">this</span>);
  <span class="hljs-built_in">Error</span>.captureStackTrace(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.constructor);
  <span class="hljs-keyword">this</span>.name = <span class="hljs-keyword">this</span>.constructor.name;
  <span class="hljs-keyword">this</span>.message = message;
}
util.inherits(OperationalError, <span class="hljs-built_in">Error</span>);
enginemill.Errors.OperationalError = OperationalError;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h4 id="enginemill-errors-notimplementederror">enginemill.Errors.NotImplementedError</h4>
<p>Useful for parts of a program which are not implemented yet. Exported
publically as <code>enginemill.Errors.NotImplementedError</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NotImplementedError</span>(<span class="hljs-params">message</span>) </span>{
  <span class="hljs-built_in">Error</span>.call(<span class="hljs-keyword">this</span>);
  <span class="hljs-built_in">Error</span>.captureStackTrace(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.constructor);
  <span class="hljs-keyword">this</span>.name = <span class="hljs-keyword">this</span>.constructor.name;
  <span class="hljs-keyword">this</span>.message = message;
}
util.inherits(NotImplementedError, OperationalError);
enginemill.Errors.NotImplementedError = NotImplementedError;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h4 id="enginemill-errors-notfounderror">enginemill.Errors.NotFoundError</h4>
<p>Used when a resource cannot be located. Exported publically as
<code>enginemill.Errors.NotFoundError</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NotFoundError</span>(<span class="hljs-params">message</span>) </span>{
  <span class="hljs-built_in">Error</span>.call(<span class="hljs-keyword">this</span>);
  <span class="hljs-built_in">Error</span>.captureStackTrace(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.constructor);
  <span class="hljs-keyword">this</span>.name = <span class="hljs-keyword">this</span>.constructor.name;
  <span class="hljs-keyword">this</span>.message = message;
}
util.inherits(NotFoundError, OperationalError);
enginemill.Errors.NotFoundError = NotFoundError;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h4 id="enginemill-errors-jsonparseerror">enginemill.Errors.JSONParseError</h4>
<p>Handle the special case of parsing JSON. Exported publically as
<code>enginemill.Errors.JSONParseError</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">JSONParseError</span>(<span class="hljs-params">message</span>) </span>{
  <span class="hljs-built_in">Error</span>.call(<span class="hljs-keyword">this</span>);
  <span class="hljs-built_in">Error</span>.captureStackTrace(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.constructor);
  <span class="hljs-keyword">this</span>.name = <span class="hljs-keyword">this</span>.constructor.name;
  <span class="hljs-keyword">this</span>.message = message;
}
util.inherits(JSONParseError, OperationalError);
enginemill.Errors.JSONParseError = JSONParseError;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h3 id="enginemill-oddcast">enginemill.oddcast</h3>
<p>Enginemill incudes the <a href="https://github.com/oddnetworks/oddcast">Oddcast</a>
library for passing messages between system components. This makes it easy
to keep your system components decoupled for true Store/Index/Query/
Presenter architecture.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>enginemill.oddcast = <span class="hljs-built_in">require</span>(<span class="hljs-string">'oddcast'</span>);
<span class="hljs-keyword">var</span> oddcast = enginemill.oddcast;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h3 id="enginemill-numeral">enginemill.numeral</h3>
<p>Enginemill includes the <a href="http://momentjs.com/">Moment</a> library to parse,
validate, manipulate and display dates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>enginemill.moment = <span class="hljs-built_in">require</span>(<span class="hljs-string">'moment'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h3 id="enginemill-numeral">enginemill.numeral</h3>
<p>Enginemill includes the <a href="http://numeraljs.com/">Numeral</a> library for
formatting and manipulating Numbers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>enginemill.numeral = <span class="hljs-built_in">require</span>(<span class="hljs-string">'numeral'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h2 id="application-loading">Application Loading</h2>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Enginemill uses your applications package.json combined wth parsed command
line options to create a preconfigured Application Object. Once the
Application Object has been constructed, it is passed into each of your
registered initializers. After each handler has initialized, the your
application is ready to begin execution.</p>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h3 id="coffeescript">CoffeeScript</h3>
<p>Enginemill registers the <a href="http://coffeescript.org/">CoffeeScript</a>
compiler before loading or
initializing your program. This way you can use CoffeeScript to write your
configuration and initialization files. In fact, you could use CoffeeScript
to write your whole program, but Enginemill holds the opinion that programs
are better written in JavaScript, while it can still be convenient to use
CoffeeScript to write your configuration files.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">require</span>(<span class="hljs-string">'coffee-script'</span>).register();</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h3 id="enginemill-load">enginemill.load</h3>
<p><code>enginemill.load()</code> is the main entry point for your program. This is where
your initializers are loaded and your program execution begins. The
expectation of Enginemill is that your application looks something like this:</p>
<pre><code class="lang-text">myapp
|- bin
|  `- start_server.js
|- lib
|  `- utils.js
|- initializers
|  |- configs.coffee
|  |- middleware.coffee
|  |- routes.coffee
|  `- databases.coffee
|- store
|  |- models.js
|  `- index.js
|- query
|  |- author_profile_index.js
|  |- article_index.js
|  `- index.js
|- presenters
|  |- users.js
|  `- posts.js
|- middleware
|  |- auth_token.js
|  `- api_response.js
|- server.js
`- package.json
</code></pre>
<h4 id="enginemill-load-arguments">enginemill.load() arguments</h4>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>appdir</strong></td>
<td><em>FilePath</em> Defaults to the directory of the currently executing script.</td>
</tr>
<tr>
<td><strong>name</strong></td>
<td><em>String</em> Defaults to the package.json “name” attribute.</td>
</tr>
<tr>
<td><strong>version</strong></td>
<td><em>String</em> Defaults to the package.json “version” attribute.</td>
</tr>
<tr>
<td><strong>usageString</strong></td>
<td><em>String</em> Used as the usage message on the command line if present.</td>
</tr>
<tr>
<td><strong>helpString</strong></td>
<td><em>String</em> Used as the help message on the command line if present.</td>
</tr>
<tr>
<td><strong>options</strong></td>
<td><em>Object</em> Command line parsing configurations.</td>
</tr>
<tr>
<td><strong>argv</strong></td>
<td><em>Object</em> Will be used instead of command line argv if present.</td>
</tr>
<tr>
<td><strong>environment</strong></td>
<td><em>String</em> Will be used instead of command line environment if present.</td>
</tr>
<tr>
<td><strong>initializers</strong></td>
<td><em>Array</em> of initializers (<em>Strings</em> or <em>Functions</em>).</td>
</tr>
</tbody>
</table>
<p><strong>Returns</strong> a Promise for the Application instance.</p>
<h4 id="example">Example</h4>
<p>In <code>bin\start_server.js</code>:</p>
<pre><code class="lang-JS"><span class="hljs-keyword">var</span> enginemill = <span class="hljs-built_in">require</span>(<span class="hljs-string">'enginemill'</span>);
<span class="hljs-keyword">var</span> server = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../server'</span>);

enginemill.load({
    appdir: enginemill.filepath.create(__dirname, <span class="hljs-string">'..'</span>),

    <span class="hljs-comment">// Plugins (expected in ../initializers/).</span>
    initializers: [
        <span class="hljs-string">'configs'</span>,
        <span class="hljs-string">'middleware'</span>,
        <span class="hljs-string">'routes'</span>,
        <span class="hljs-string">'databases'</span>
    ]
})
.then(server.start)
.catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'There was an error starting the server:'</span>);
    <span class="hljs-built_in">console</span>.error(err.stack || err.message || err);
    process.exit(<span class="hljs-number">1</span>);
});
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>enginemill.load = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>{
  sendDebug(<span class="hljs-string">'Beginning enginemill.load().'</span>);

  args = args || <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">var</span> promise;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h4 id="appdir">appdir</h4>
<p>The load sequence begins by determining what the application root
directory is going to be. If <code>args.appdir</code> is a FilePath instance
<code>enginemill.load()</code> will use it as is. If it is a String then
<code>enginemill.load()</code> will create a FilePath instance from it. Othewise
a FilePath instance referencing the directory of the executing script
is used as a best guess by default.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> appdir;
  <span class="hljs-keyword">if</span> (args.appdir &amp;&amp; args.appdir <span class="hljs-keyword">instanceof</span> filepath.FilePath) {
    appdir = args.appdir;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> args.appdir === <span class="hljs-string">'string'</span>) {
    appdir = filepath.create(args.appdir);
  } <span class="hljs-keyword">else</span> {
    appdir = filepath.create().resolve(process.argv[<span class="hljs-number">1</span>]).dirname();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h4 id="asynchronous-application-loading">Asynchronous Application Loading</h4>
<p>Once the <code>appdir</code> has been determined, the process is asynchronously
loaded by executing in order through a chained series of Promise handlers.
The first Promise in the chain is simply contructing an arguments Object
hash to pass through the rest of the chain.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  promise = <span class="hljs-built_in">Promise</span>.resolve({
      appdir       : appdir,
      name         : args.name,
      version      : args.version,
      usageString  : args.usageString,
      helpString   : args.helpString,
      options      : args.options,
      argv         : args.argv,
      environment  : args.environment,
      initializers : args.initializers
    })</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h4 id="read-package-json">Read package.json</h4>
<p>After determining the root application directory and constructing the
arguments hash the package.json is
read and will be available as <code>app.packageJSON</code>. The <code>app.name</code> and
<code>app.version</code> are also determined by the package.json, but can be
overridden with <code>args.name</code> and <code>args.version</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadPackageJSON</span>(<span class="hljs-params">args</span>) </span>{
      <span class="hljs-keyword">var</span> path = args.appdir.append(<span class="hljs-string">'package.json'</span>);
      <span class="hljs-keyword">return</span> enginemill.readJSON({path: path}).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) </span>{
        args.packageJSON = res || <span class="hljs-literal">null</span>;
        sendDebug(<span class="hljs-string">'.load() package.json has loaded.'</span>);
        <span class="hljs-keyword">return</span> args;
      });
    })</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h4 id="command-line-options-parsing">Command Line Options Parsing</h4>
<p>Next, the command line arguments are parsed based on the <code>args.options</code>
Object passed in. The parsed command line arguments will be available on
the Application instance as <code>app.argv</code>. If <code>args.argv</code> was passed into
<code>enginemill.load()</code>, this
step will be skipped and it will be assigned to <code>app.argv</code> instead.
Command line options parsing is directed by the <code>args.options</code> Object
passed into <code>enginemill.load()</code>, as well as the <code>args.usageString</code> and
<code>args.helpString</code>.</p>
<p>The <code>args.options</code> hash passed into <code>enginemill.load()</code> should contain a hash
of arguments with an object for each value containing:</p>
<ul>
<li>alias - String</li>
<li>describe - Description String</li>
<li>demand - Boolean</li>
<li>type - String (“boolean”|”string”)</li>
<li>default - Any value</li>
</ul>
<p><strong>Example:</strong></p>
<pre><code class="lang-JS">enginemill.load({
  options: {
    environment: {
      describe: <span class="hljs-string">"The environment setting."</span>,
      type: <span class="hljs-string">"string"</span>,
      <span class="hljs-keyword">default</span>: <span class="hljs-string">"development"</span>
    },
    verbose: {
      alias: <span class="hljs-string">"v"</span>,
      describe: <span class="hljs-string">"Set logging on."</span>,
      type: <span class="hljs-string">"boolean"</span>
    }
  }
  initializers: [
    <span class="hljs-string">'configs'</span>,
    <span class="hljs-string">'middleware'</span>
  ]
})
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadCommandLineArgs</span>(<span class="hljs-params">args</span>) </span>{
      <span class="hljs-keyword">if</span> (!args.argv) {
        args.argv = enginemill.parseCommandLineOptions(args);
        sendDebug(<span class="hljs-string">'.load() parsed command line options.'</span>);
      } <span class="hljs-keyword">else</span> {
        sendDebug(<span class="hljs-string">'.load() skipped command line option parsing.'</span>);
      }
      <span class="hljs-keyword">return</span> args;
    })</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h4 id="environment-setting">Environment Setting</h4>
<p>The environment setting String will be available on the Application
instance as <code>app.environment</code>. If “–environment” is present from the
command line, it will take precedence. If the “ENVIRONMENT” environment
variable is set, it will be used next. After that, the “NODE_ENV”
environment variable is used, followed by the passed in
<code>args.environment</code> and the default <code>enginemill.DEFAULTS.ENVIRONMENT</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setEnvironment</span>(<span class="hljs-params">args</span>) </span>{
      sendDebug(<span class="hljs-string">'.load() args.argv.environment = %s.'</span>, args.argv.environment);
      sendDebug(<span class="hljs-string">'.load() process.env.ENVIRONMENT = %s.'</span>, process.env.ENVIRONMENT);
      sendDebug(<span class="hljs-string">'.load() process.env.NODE_ENV = %s.'</span>, process.env.NODE_ENV);
      sendDebug(<span class="hljs-string">'.load() args.environment = %s.'</span>, args.environment);
      args.environment = args.argv.environment ||
                         process.env.ENVIRONMENT ||
                         process.env.NODE_ENV ||
                         args.environment ||
                         enginemill.DEFAULTS.ENVIRONMENT;
      sendDebug(<span class="hljs-string">'.load() set environment to %s.'</span>, args.environment);
      <span class="hljs-keyword">return</span> args;
    })</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h4 id="create-the-application-instance">Create the Application Instance</h4>
<p>With the package.json, command line arguments, and environment setting
in hand, the load process will create an Application instance. The
Application instance will be passed into all the initialization functions
and should be referenced in your application simply as <code>app</code>. The
Application instance will include usefull attributes like <code>app.name</code> and
<code>app.environment</code> as well as the <code>app.argv</code> Object containing the parsed
command line arguments. In your initializers, you’ll probably want to
extend the <code>app.configs</code> and <code>app.API</code> Objects to provide useful
references for the rest of your program.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createApplication</span>(<span class="hljs-params">args</span>) </span>{
      <span class="hljs-keyword">var</span> packageJSON = args.packageJSON || <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);

      args.app = Application.create({
        name        : args.name ||
                      packageJSON.name ||
                      enginemill.DEFAULTS.APP_NAME,
        version     : args.version ||
                      packageJSON.version ||
                      enginemill.DEFAULTS.APP_VERSION,
        appdir      : args.appdir,
        packageJSON : args.packageJSON,
        environment : args.environment,
        argv        : args.argv
      });

      sendDebug(<span class="hljs-string">'.load() Application instance has been created.'</span>);
      <span class="hljs-keyword">return</span> args;
    })</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h4 id="load-initializers">Load Initializers</h4>
<p>After the Application instance has been created the initializers are
loaded and executed in serial. The initializers to are defined by
the <code>args.initializers</code> Array passed into <code>enginemill.load()</code>. See
the <strong>Initializer Loading</strong> section for more information.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadInitializers</span>(<span class="hljs-params">args</span>) </span>{
      sendDebug(<span class="hljs-string">'.load() Loading and executing initializers.'</span>);
      <span class="hljs-keyword">return</span> enginemill.loadInitializers(args).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">app</span>) </span>{
        args.app = app;
        sendDebug(<span class="hljs-string">'.load() Initializers have executed.'</span>);
        <span class="hljs-keyword">return</span> args;
      });
    })</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h4 id="return-a-promise">Return a Promise</h4>
<p>Finally <code>enginemill.load()</code> returns a Promise for the Application instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">returnApplication</span>(<span class="hljs-params">args</span>) </span>{
      sendDebug(<span class="hljs-string">'.load() Done. Returning Appliation instance.'</span>);
      <span class="hljs-keyword">return</span> args.app;
    });

  <span class="hljs-keyword">return</span> promise;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h3 id="defaults">Defaults</h3>
<p>Some default options used by Enginemill which you can extend by modifying
the <code>enginemill.DEFAULTS</code> Object. See <strong>enginemill.load</strong> above for more
information about how these are used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>enginemill.DEFAULTS = {
  ENVIRONMENT      : <span class="hljs-string">'development'</span>,
  INITIALIZER_PATH : <span class="hljs-string">'initializers'</span>,
  APP_NAME         : <span class="hljs-string">'not-named'</span>,
  APP_VERSION      : <span class="hljs-string">'0'</span>
};</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h3 id="enginemill-application">enginemill.Application</h3>
<p>The Application object is constructed during the <code>enginemill.load()</code>
routine and is passed into your initilizers. After all your initializers
have executed the Application instance is returned in the Promise returned
from <code>enginemill.load()</code>. See the <strong>Initializer Loading</strong> section for more
information. From there, best practice is to pass it into the
other components of your program.</p>
<h4 id="enginemill-application-instance-properties">enginemill.Application instance properties</h4>
<p><strong>#name</strong> <em>String</em> The name of your application. The name is taken from the
<code>args.name</code> value passed into <code>enginemill.load()</code> or automatically taken
from your package.json.</p>
<p><strong>#version</strong> <em>String</em> The version of your application. The version is taken
from the <code>args.version</code> value passed into <code>enginemill.load()</code> or
automatically taken from your package.json.</p>
<p><strong>#appdir</strong> <em>FilePath</em> The FilePath instance representing the root directory
of your application. See the <strong>appdir</strong> section for more information.</p>
<p><strong>#packageJSON</strong> <em>Object</em> Your application package.json parsed into an
Object.</p>
<p><strong>#environment</strong> <em>String</em> The environment setting. See the <strong>Environment
Setting</strong> section for more information.</p>
<p><strong>#configs</strong> <em>Object</em> A blank Object where you should set your configuration
settings in initializers.</p>
<p><strong>#argv</strong> <em>Object</em> An Object containing your parsed command line options.
See <strong>Command Line Option Parsing</strong> for more information.</p>
<p><strong>#logger</strong> <em>Object</em> The application logger instance. See the <strong>Logging</strong>
section for more information.</p>
<p><strong>#API</strong> <em>Object</em> A blank object for you to attach your plugins to in
initiallizers.</p>
<h4 id="enginemill-application-instance-methods">enginemill.Application instance methods</h4>
<p><strong>#debug(name)</strong> A proxy to the node-debug tool. Pass in a String name and
it will return a new debugger bound to it by <code>debug(name + &#39;:&#39; + name)</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Application</span>(<span class="hljs-params"></span>) </span>{}
enginemill.Application = Application;

U.extend(Application.prototype, {

  initialize: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">spec</span>) </span>{
    <span class="hljs-built_in">Object</span>.defineProperties(<span class="hljs-keyword">this</span>, {
      name: {
        enumerable: <span class="hljs-literal">true</span>,
        value: spec.name
      },
      version: {
        enumerable: <span class="hljs-literal">true</span>,
        value: spec.version
      },
      appdir: {
        enumerable: <span class="hljs-literal">true</span>,
        value: spec.appdir
      },
      packageJSON: {
        enumerable: <span class="hljs-literal">true</span>,
        value: spec.packageJSON ? U.deepFreeze(spec.packageJSON) : <span class="hljs-literal">null</span>
      },
      environment: {
        enumerable: <span class="hljs-literal">true</span>,
        value: spec.environment
      },
      configs: {
        enumerable: <span class="hljs-literal">true</span>,
        value: <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>)
      },
      argv: {
        enumerable: <span class="hljs-literal">true</span>,
        value: U.deepFreeze(U.ensure(spec.argv))
      },
      logger: {
        enumerable: <span class="hljs-literal">true</span>,
        value: Logger.create({
          appname: spec.name
        })
      },
      API: {
        enumerable: <span class="hljs-literal">true</span>,
        value: <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>)
      },
      debug: {
        enumerable: <span class="hljs-literal">true</span>,
        value: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name</span>) </span>{
          <span class="hljs-keyword">return</span> debug(name + <span class="hljs-string">':'</span> + name);
        }
      }
    });
  }
});

Application.create = U.factory(Application.prototype);</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h3 id="initializer-loading">Initializer Loading</h3>
<p>The initialization loader requires and loads all initializers passed in as
Strings. Initailization modules must export a Function with
<code>module.exports = function () { ... }</code>.
Initialization Functions may also be passed in and will be used
directly.</p>
<p>After the initializer functions are loaded they are exectuted serially in
order. Each initializer function is passed a single argument; the
Application instance. Extending the <code>app.configs</code> or <code>app.API</code> Objects
is a great use of an initializer. It is expected that initializers will
complete aysnchronously, and if so, they should return a Promise.</p>
<p><strong>Example</strong></p>
<p>Good example of an initializer which sets configuration settings:</p>
<pre><code class="lang-CoffeeScript"><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-params">(app)</span> -&gt;</span>
    <span class="hljs-comment"># app.environment is set with the --environment option, or the</span>
    <span class="hljs-comment"># NODE_ENV environment variable.</span>
    app.configs.port = <span class="hljs-keyword">if</span> app.environment <span class="hljs-keyword">is</span> <span class="hljs-string">'production'</span> <span class="hljs-keyword">then</span> <span class="hljs-number">8080</span> <span class="hljs-keyword">else</span> <span class="hljs-number">3000</span>

    <span class="hljs-comment"># Set the public path to '../public'</span>
    app.configs.public_path = app.appdir.append <span class="hljs-string">'public'</span>
</code></pre>
<h3 id="enginemill-loadinitializers">enginemill.loadInitializers</h3>
<p>Typically you can just allow <code>enginemill.load</code> to call
<code>enginemill.loadInitializers</code>, but in case you need to extend it, or call
it separately, it is available as <code>enginemill.loadInitializers</code>.</p>
<h4 id="arguments">Arguments</h4>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>app</strong></td>
<td><em>Application instance</em> The initialized Application Object.</td>
</tr>
<tr>
<td><strong>initializers</strong></td>
<td><em>Array</em> List of Strings or Functions.</td>
</tr>
</tbody>
</table>
<p><strong>Returns</strong> A Promise for the Application instance after all initializers
have been executed in order.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>enginemill.loadInitializers = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>{
  <span class="hljs-keyword">var</span>
  initializers, app, dir;

  <span class="hljs-keyword">if</span> (!args.initializers) {
    initializers = [];
  } <span class="hljs-keyword">else</span> {
    initializers = <span class="hljs-built_in">Array</span>.isArray(args.initializers) ?
                   args.initializers : [args.initializers];
  }

  app = args.app;
  dir = app.appdir.append(enginemill.DEFAULTS.INITIALIZER_PATH);

  <span class="hljs-keyword">return</span> initializers

    .map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">module, index</span>) </span>{
      <span class="hljs-keyword">var</span> path, message;

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span> === <span class="hljs-string">'string'</span>) {
        path = dir.append(<span class="hljs-built_in">module</span>).toString();
        <span class="hljs-keyword">try</span> {
          <span class="hljs-built_in">module</span> = <span class="hljs-built_in">require</span>(path);
        } <span class="hljs-keyword">catch</span> (moduleError) {
          <span class="hljs-keyword">if</span> (moduleError.code === <span class="hljs-string">'MODULE_NOT_FOUND'</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Errors.NotFoundError(<span class="hljs-string">'Initializer module not found: '</span>+ path);
          }
          <span class="hljs-keyword">throw</span> moduleError;
        }
      }

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span> !== <span class="hljs-string">'function'</span>) {
        message = path ? (<span class="hljs-string">'path '</span>+ path) : (<span class="hljs-string">'index '</span>+ index);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Errors.OperationalError(<span class="hljs-string">'Initializers must be functions: '</span>+ message);
      }

      <span class="hljs-keyword">return</span> <span class="hljs-built_in">module</span>;
    })

    .reduce(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">promise, module</span>) </span>{
      <span class="hljs-keyword">return</span> promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">app</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-built_in">module</span>(app)).then(U.constant(app));
      });
    }, <span class="hljs-built_in">Promise</span>.resolve(args.app));
};</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h2 id="factories-and-mixins">Factories and Mixins</h2>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Enginemill includes an Object factory mixed into lodash as
<code>enginemill.U.factory()</code>. This factory creator accepts any number of mixins,
plus your own prototype definitions to compose factory functions for
Objects.</p>
<h3 id="creating-factories">Creating Factories</h3>
<p><code>enginemill.U.factory()</code> returns a Function which
will create new Objects using a prototype composed of the mixins passed in.
The returned Object factory Function will automatically call initialize()
on your object instance. If there is an initialize() function defined on any
of the mixins, they will also be called, in order, before your mixin.</p>
<p><strong>Example:</strong></p>
<pre><code class="lang-JS"><span class="hljs-keyword">var</span> newWidget = enginemill.U.factory(enginemill.Mixins.Model, {
  name: <span class="hljs-string">'Widget'</span>,
  idAttribute: <span class="hljs-string">'_id'</span>,

  defaults: {
    _id    : <span class="hljs-literal">null</span>,
    width  : <span class="hljs-number">5</span>,
    height : <span class="hljs-number">2</span>
  },

  initialize: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>.cid = randomString();
  },

  area: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.width * <span class="hljs-keyword">this</span>.height;
  }
});
</code></pre>
<h3 id="mixins">Mixins</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>enginemill.Mixins = {</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <h4 id="enginemill-mixins-model">enginemill.Mixins.Model</h4>
<p>An Object mixin for creating Immutable models. Define a set of default
values in your definition and the keys will be used to enforce assignment
rules on the instance. Includes a mechnanism for naming the type for your
model, as well as assigning an ID.</p>
<p><strong>Example:</strong></p>
<pre><code class="lang-JS"><span class="hljs-keyword">var</span> newWidget = enginemill.U.factory(enginemill.Mixins.Model, {
  name: <span class="hljs-string">'Widget'</span>,
  idAttribute: <span class="hljs-string">'_id'</span>,

  defaults: {
    _id    : <span class="hljs-literal">null</span>,
    width  : <span class="hljs-number">5</span>,
    height : <span class="hljs-number">2</span>
  },

  initialize: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>.cid = randomString();
  },

  area: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.width * <span class="hljs-keyword">this</span>.height;
  }
});

<span class="hljs-keyword">var</span> widget = newWidget({width: <span class="hljs-number">4</span>, height: <span class="hljs-number">4</span>});
widget.area(); <span class="hljs-comment">// 16</span>
</code></pre>
<p>Setting the defaults Object hash determines not only what the default
values will be for the keys, but also which keys are allowed on an instance
of this model. Using #set() to set a key which was not defined in the
defaults hash will throw an error.</p>
<h4 id="enginemill-mixin-model-instance-properties">enginemill.Mixin.Model instance properties</h4>
<p><strong>#name</strong> A frozen enumerable property. Used in #toString() and #diff().</p>
<p><strong>#idAttribute</strong> A non-enumerable prototype property used to determine the
ID.</p>
<h4 id="enginemill-mixin-model-instance-methods">enginemill.Mixin.Model instance methods</h4>
<p><strong>#has(key)</strong> Check to see if the model instance has the given key,
regardless of if it is defined or not.</p>
<p><strong>#hasId()</strong> Check to see if the ID property defined by #idAttribute is
present.</p>
<p><strong>#set(values)</strong> Pass in an Object hash of key/value pairs to set.
Attempting to set a key which was not defined in the defaults will throw an
Error. Returns a new instance of the model.</p>
<p><strong>#diff(otherInstance)</strong> Pass in another model instance to determine if they
are different. Returns <code>null</code> if they are the same, or an Array of
differences if they are not. Each item in the diff Array is another Array
containing [key, selfValue, otherValue].</p>
<p><strong>#toJSON()</strong> Returns a new Object containing all the key/value pairs
defined on this model instance. This makes
<code>JSON.stringify(myModelInstance)</code> work as you would expect.</p>
<p><strong>#toString()</strong> Returns a special String representation of this model
instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Model: BRIXX.Model,</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <h4 id="enginemill-mixins-eventemitter">enginemill.Mixins.EventEmitter</h4>
<p>The EventEmitter mixin is the Node.js EventEmitter prototype Object with
a #destroy() method added to it. When you call #destroy() on an instance
created with the <code>enginemill.Mixins.EventEmitter</code> it will call</p>
<p>#removeAllListeners() on the EventEmitter for you.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  EventEmitter: (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> proto = <span class="hljs-built_in">Object</span>.keys(EventEmitter.prototype).reduce(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">proto, k</span>) </span>{
      proto[k] = EventEmitter.prototype[k];
      <span class="hljs-keyword">return</span> proto;
    }, <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>));

    proto.initialize = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      EventEmitter.init.call(<span class="hljs-keyword">this</span>);
    };

    proto.destroy = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">this</span>.removeAllListeners();
    };

    <span class="hljs-keyword">return</span> proto;
  }())
};</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <h2 id="logging">Logging</h2>

            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Enginemill includes an application level logging system out of the box. It
is designed to be easy to extend, or not use at all. It does this
by emitting logging events on an Oddcast broadaster, which you can listen
to with any other logging tools you’d like to use.</p>
<p>The logging calls are taken by the
<a href="https://github.com/trentm/node-bunyan">Bunyan logging library</a>,
and then the
resulting log records created by Bunyan are emitted through the
broadcaster. By default the logging system is initialized with a listener
which simply writes the Bunyan log records as JSON to stdout.</p>
<p>You can set your own listeners, or turn off logging altogether, by
calling #configure() on the logger.</p>
<p>You create new loggers by calling #create() on the logger instance.</p>
<p><strong>Example:</strong></p>
<pre><code class="lang-JS"><span class="hljs-comment">// Pass in the Application instance to a Store submodule.</span>
exports.create = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">app</span>) </span>{
  <span class="hljs-keyword">var</span> logger = app.logger.create({store: <span class="hljs-string">'users'</span>});

  logger.trace(<span class="hljs-string">'a trace message'</span>);
  <span class="hljs-comment">// {"name":"myapp","hostname":"myhost","pid":34572,"store":"users","level":10,"msg":"a trace message","time":"2013-01-04T07:47:25.814Z","v":0}</span>

  logger.debug({modelName: <span class="hljs-string">'Widget'</span>}, <span class="hljs-string">'a widget'</span>);
  <span class="hljs-comment">// {"name":"myapp","hostname":"myhost","pid":34572,"store":"users","level":20,"modelName":"Wdiget",msg":"a widget","time":"2013-01-04T07:47:25.815Z","v":0}</span>

  logger.info(<span class="hljs-string">'hi %s'</span>, <span class="hljs-string">'John'</span>);
  <span class="hljs-comment">// {"name":"myapp","hostname":"myhost","pid":34572,"store":"users","level":30,"msg":"hi John","time":"2013-01-04T07:47:25.814Z","v":0}</span>

  logger.warn(<span class="hljs-string">'A warning'</span>);
  <span class="hljs-comment">// {"name":"myapp","hostname":"myhost","pid":34572,"store":"users","level":40,"msg":"A warning","time":"2013-01-04T07:47:25.814Z","v":0}</span>

  logger.error(err);
  <span class="hljs-comment">// Special case to log an `Error` instance to the record.</span>
  <span class="hljs-comment">// This adds an "err" field with exception details</span>
  <span class="hljs-comment">// (including the stack) and sets "msg" to the exception</span>
  <span class="hljs-comment">// message.</span>

  logger.fatal(err, <span class="hljs-string">'a message about this error'</span>);
  <span class="hljs-comment">// Almost the same as above, but will specify the msg portion of the</span>
  <span class="hljs-comment">// log record.</span>
}
</code></pre>
<h3 id="enginemill-logger">enginemill.Logger</h3>
<p>An instance of <code>enginemill.Logger</code> will be placed on the Application
instance as <code>app.logger</code>.</p>
<h4 id="enginemill-logger-instance-methods">enginemill.Logger instance methods</h4>
<p><strong>#configure(args)</strong> Reconfigure the default logging setup.</p>
<p><code>args.level</code> Should be a string to set the global log level. One of
“TRACE”, “DEBUG”, “INFO”, “WARN”, “ERROR”, “FATAL”.</p>
<p>If <code>args.useDefaultObserver</code> is <code>false</code> the default observer will be
removed and the logger will no longer write to stdout. If
<code>args.useDefaultObserver</code> is <code>true</code> the logger will reset the default
observer and write to stdout.</p>
<p><strong>#create(attributes)</strong> Creates a new logger which will always log the
given attributes.</p>
<h4 id="adding-log-record-observers">Adding Log Record Observers</h4>
<p>Adding your own observers is simple; just pass a pattern and handler
function into <code>app.logger.channel.observe()</code> like so:</p>
<pre><code class="lang-CoffeeScript"><span class="hljs-comment"># In logging.coffee initializer:</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-params">(app)</span> -&gt;</span>
  <span class="hljs-comment"># Observe only error log records</span>
  errors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/logging_error_handler'</span>).create(app)
  app.logger.channel.observe {<span class="hljs-attribute">role</span>: <span class="hljs-string">'logging'</span>, <span class="hljs-attribute">level</span>: <span class="hljs-string">'error'</span>}, errors
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Logger</span>(<span class="hljs-params"></span>) </span>{}
enginemill.Logger = Logger;

U.extend(Logger.prototype, {

  initialize: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>{
    <span class="hljs-keyword">this</span>.channel = oddcast.eventChannel();
    <span class="hljs-keyword">this</span>.channel.use({role: <span class="hljs-string">'logging'</span>}, oddcast.inprocessTransport());

    <span class="hljs-keyword">this</span>.logger = Logger.bunyan.createLogger({
      name: args.appname
    });

    <span class="hljs-keyword">this</span>.logger.streams = [];
    <span class="hljs-keyword">this</span>.logger.addStream({
      type: <span class="hljs-string">'raw'</span>,
      stream: <span class="hljs-keyword">new</span> Logger.EmitterRawStream({
        channel: <span class="hljs-keyword">this</span>.channel
      }),
      closeOnExit: <span class="hljs-literal">false</span>
    });

    <span class="hljs-keyword">this</span>.defaultObserver = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">rec</span>) </span>{
      process.stdout.write(<span class="hljs-built_in">JSON</span>.stringify(rec));
    };

    <span class="hljs-keyword">this</span>.channel.observe({role: <span class="hljs-string">'logging'</span>}, <span class="hljs-keyword">this</span>.defaultObserver);
  },

  configure: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">configs</span>) </span>{
    configs = U.ensure(configs);

    <span class="hljs-keyword">if</span> (U.isBoolean(configs.useDefaultObserver)) {
      <span class="hljs-keyword">if</span> (configs.useDefaultObserver) {
        sendDebug(<span class="hljs-string">'Logger use default observer.'</span>);
        <span class="hljs-keyword">this</span>.channel.remove({role: <span class="hljs-string">'logging'</span>}, <span class="hljs-keyword">this</span>.defaultObserver);
        <span class="hljs-keyword">this</span>.channel.observe({role: <span class="hljs-string">'logging'</span>}, <span class="hljs-keyword">this</span>.defaultObserver);
      } <span class="hljs-keyword">else</span> {
        sendDebug(<span class="hljs-string">'Logger Remove default observer.'</span>);
        <span class="hljs-keyword">this</span>.channel.remove({role: <span class="hljs-string">'logging'</span>}, <span class="hljs-keyword">this</span>.defaultObserver);
      }
    }

    <span class="hljs-keyword">if</span> (configs.level) {
      <span class="hljs-keyword">this</span>.logger.level(configs.level);
    }
  },

  create: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">attributes</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.logger.child(attributes);
  }
});

Logger.create = U.factory(Logger.prototype);</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <h4 id="enginemill-logger-log-levels-">enginemill.Logger log levels:</h4>
<ul>
<li>Logger.FATAL = ‘fatal’</li>
<li>Logger.ERROR = ‘error’</li>
<li>Logger.WARN  = ‘warn’</li>
<li>Logger.INFO  = ‘info’</li>
<li>Logger.DEBUG = ‘debug’</li>
<li>Logger.TRACE = ‘trace’</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>Logger.FATAL = <span class="hljs-string">'fatal'</span>;
Logger.ERROR = <span class="hljs-string">'error'</span>;
Logger.WARN  = <span class="hljs-string">'warn'</span>;
Logger.INFO  = <span class="hljs-string">'info'</span>;
Logger.DEBUG = <span class="hljs-string">'debug'</span>;
Logger.TRACE = <span class="hljs-string">'trace'</span>;

Logger.PATTERNS = {
  FATAL : {role: <span class="hljs-string">'logging'</span>, level: Logger.FATAL},
  ERROR : {role: <span class="hljs-string">'logging'</span>, level: Logger.ERROR},
  WARN  : {role: <span class="hljs-string">'logging'</span>, level: Logger.WARN},
  INFO  : {role: <span class="hljs-string">'logging'</span>, level: Logger.INFO},
  DEBUG : {role: <span class="hljs-string">'logging'</span>, level: Logger.DEBUG},
  TRACE : {role: <span class="hljs-string">'logging'</span>, level: Logger.TRACE}
};

Logger.bunyan = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bunyan'</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EmitterRawStream</span>(<span class="hljs-params">spec</span>) </span>{
  <span class="hljs-keyword">this</span>.channel = spec.channel;
}
EmitterRawStream.prototype.write = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">rec</span>) </span>{
  <span class="hljs-keyword">var</span> level = Logger.bunyan.nameFromLevel[rec.level].toUpperCase();
  <span class="hljs-keyword">this</span>.channel.broadcast(Logger.PATTERNS[level], rec);
};

Logger.EmitterRawStream = EmitterRawStream;</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <h2 id="database-connector">Database Connector</h2>

            </div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>The core functionality of your application Store is to store data in a
database. The <code>enginemill.DatabaseConnector</code> provides a consistent API for
writing data changes to your database of choice from within your Store.</p>
<h3 id="enginemill-databaseconnector">enginemill.DatabaseConnector</h3>
<p>The DatabaseConnector takes an underlying database engine you create, and a
list of Model factory functions, and creates a database API.</p>
<h4 id="enginemill-databaseconnector-class-methods">enginemill.DatabaseConnector class methods</h4>
<p><strong>.create(spec)</strong> create a new databaseconnector api.</p>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>engine</strong></td>
<td><em>Object</em> A database engine following the <strong>Database Engine Interface</strong> contract.</td>
</tr>
<tr>
<td><strong>factories</strong></td>
<td><em>Object</em> Index of factory functions by Model name.</td>
</tr>
</tbody>
</table>
<p><strong>Returns</strong> A DatabaseConnector instance.</p>
<h4 id="enginemill-databaseconnector-instance-methods">enginemill.DatabaseConnector instance methods</h4>
<p><strong>#get(id, options)</strong> Should get an entity by calling <code>engine.get()</code> and
return a Promise for the Model instance from the appropriate factory denoted
by <code>data.name</code>.</p>
<p><strong>#post(entity, options)</strong> Accepts a Model instance as the first argument.
Serializes the entity into a record Object and passes it into
<code>engine.post()</code>. The entity must not yet have an ID assigned. Returns a
Promise for a new Model instance representing the saved entity.</p>
<p><strong>#put(entity, options)</strong> Accepts a Model instance as the first argument.
Serializes the entity into a record Object and passes it into
<code>engine.put()</code>. The entity must already have an ID assigned. Returns a
Promise for a new Model instance representing the saved entity.</p>
<p><strong>#remove(id, options)</strong> Should remove an entity by calling
<code>engine.remove()</code> and return a Promise for the ID of the removed entity.</p>
<h3 id="database-engine-interface">Database Engine Interface</h3>
<p>An interface contract specification. When an Object meets this contract it
can be passed into <code>enginemill.DatabaseConnector.create(spec)</code> as the
<code>spec.engine</code>.</p>
<h4 id="database-engine-instance-methods">Database Engine instance methods</h4>
<p><strong>.get(id, options)</strong> Must accept a String or Number ID as the first
argument. May accept an options Object as the second argument.
May throw an Error if a String or Number ID is not provided. Must
return a Promise for an Object representing the data stored at <code>id</code>. If the
data does not exist it must reject the Promise with an
<code>enginemill.Errors.NotFoundError</code>.</p>
<p><strong>.post(record, options)</strong> Must accept a record Object with <code>record.data</code>
attribute as the first argument. May accept an options Object as the second
argument. May throw an Error if a <code>record.id</code> attribute is provided. It is
assumed .post(record) will assign an ID to the record. Must return a
Promise for the record data as written to the underlying database.</p>
<p><strong>.put(record, options)</strong> Must accept a record Object with both
<code>record.data</code> and <code>record.id</code> attributes as the first argument. May accept
an optinos Object as the second argument. May throw an Error if
<code>record.id</code> or <code>record.data</code> are not provided. Must return a Promise for the
data stored at <code>id</code>. If <code>id</code> does not exist in the database .put(record)
must reject the returned Promise with an <code>enginemill.Errors.NotFoundError</code>.</p>
<p><strong>.remove(record, options)</strong> Must accept a String or Number ID as the first
argument. May accept an options Object as the second Argument.
May throw an Error if a String or Number ID is not provided.
Must return a Promise for the ID String or Number. If the record cannot
be found it must reject the Promise with an
<code>enginemill.Errors.NotFoundError</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DatabaseConnector</span>(<span class="hljs-params"></span>) </span>{}
enginemill.DatabaseConnector = DatabaseConnector;

U.extend(DatabaseConnector.prototype, {
  initialize: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">spec</span>) </span>{
    <span class="hljs-keyword">this</span>.engine    = spec.engine;
    <span class="hljs-keyword">this</span>.factories = spec.factories;
  },

  get: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, options</span>) </span>{
    options = options || <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.engine.get(id, options).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
      <span class="hljs-keyword">return</span> self.factory(data);
    });
  },

  post: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entity, options</span>) </span>{
    options = options || <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">var</span>
    self   = <span class="hljs-keyword">this</span>,
    record = <span class="hljs-keyword">this</span>.serialize(entity);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.engine.post(record, options).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
      <span class="hljs-keyword">return</span> self.factory(data);
    });
  },

  put: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entity, options</span>) </span>{
    options = options || <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">var</span>
    self   = <span class="hljs-keyword">this</span>,
    record = <span class="hljs-keyword">this</span>.serialize(entity);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.engine.put(record, options).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
      <span class="hljs-keyword">return</span> self.factory(data);
    });
  },

  remove: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id, options</span>) </span>{
    options = options || <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.engine.remove(id, options);
  },

  factory: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
    <span class="hljs-keyword">var</span> factory = <span class="hljs-keyword">this</span>.factories[data.name];
    <span class="hljs-keyword">if</span> (!factory) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Missing factory for "'</span> + data.name + <span class="hljs-string">'"'</span>);
    }
    <span class="hljs-keyword">return</span> factory(data);
  },

  serialize: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entity</span>) </span>{
    <span class="hljs-keyword">var</span> record  = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    record.id   = entity.id;
    record.data = entity;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> entity.toJSON === <span class="hljs-string">'function'</span>) {
      record.data = entity.toJSON();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> entity.valueOf === <span class="hljs-string">'function'</span>) {
      record.data = entity.valueOf();
    }

    <span class="hljs-keyword">if</span> (entity.idAttribute) {
      record.id = entity[entity.idAttribute];
    }

    <span class="hljs-keyword">return</span> record;
  }
});

DatabaseConnector.create = U.factory(DatabaseConnector.prototype);</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h3 id="jsonfiledatabase">JSONFileDatabase</h3>
<p>For convenience during development Enginemill provides a simple JSON file
storage engine which impements the <strong>Database Engine Interface</strong>. You can
create an <strong>enginemill.DatabaseConnector</strong> which uses it:</p>
<pre><code class="lang-JS"><span class="hljs-keyword">var</span> db = enginemill.DatabaseConnector.create({
  engine: enginemill.JSONFileDatabase.create({
    dir: enginemill.filepath.root().append(<span class="hljs-string">'tmp'</span>, <span class="hljs-string">'appdata'</span>)
  }),

  factories: {
    Car: createCar
  }
});

db.get();
db.post();
db.put();
db.remove();
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">JSONFileDatabase</span>(<span class="hljs-params"></span>) </span>{}
enginemill.JSONFileDatabase = JSONFileDatabase;

U.extend(JSONFileDatabase.prototype, {

  initialize: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>{
    <span class="hljs-keyword">if</span> (!args.dir) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'args.dir is required for JSONFileDatabase'</span>);
    }

    <span class="hljs-keyword">this</span>.nodeId = args.nodeId;
    <span class="hljs-keyword">this</span>.dir = filepath.create(args.dir);
  },

  get: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id</span>) </span>{
    <span class="hljs-keyword">if</span> (!id) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'SimpleFileDB#get() requires an ID argument'</span>);
    }
    <span class="hljs-keyword">var</span> file = <span class="hljs-keyword">this</span>.dir.append(id + <span class="hljs-string">'.json'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(file.read().then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">text</span>) </span>{
      <span class="hljs-keyword">var</span> err;
      <span class="hljs-keyword">if</span> (text) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(text);
      }
      err = <span class="hljs-keyword">new</span> Errors.NotFoundError(<span class="hljs-string">'Could not find record with id "'</span> + id + <span class="hljs-string">'"'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(err);
    }));
  },

  post: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">record</span>) </span>{
    <span class="hljs-keyword">if</span> (record.id) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'SimpleFileDB#post() does not accept a record ID'</span>);
    }
    <span class="hljs-keyword">var</span>
    file,
    id = <span class="hljs-keyword">this</span>.uuid();
    record.data.id = id;
    file = <span class="hljs-keyword">this</span>.dir.append(id + <span class="hljs-string">'.json'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(file.write(<span class="hljs-built_in">JSON</span>.stringify(record.data)).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">JSON</span>.stringify(record.data));
    }));
  },

  put: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">record</span>) </span>{
    <span class="hljs-keyword">if</span> (!record.id) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'SimpleFileDB#put() requires a record with an ID'</span>);
    }
    <span class="hljs-keyword">var</span>
    err,
    file = <span class="hljs-keyword">this</span>.dir.append(record.id + <span class="hljs-string">'.json'</span>),
    text = <span class="hljs-built_in">JSON</span>.stringify(record.data);

    <span class="hljs-keyword">if</span> (file.isFile()) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(file.write(text).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(text);
      }));
    }
    err = <span class="hljs-keyword">new</span> Errors.NotFoundError(<span class="hljs-string">'Could not find record with id "'</span> + record.id + <span class="hljs-string">'"'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(err);
  },

  remove: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id</span>) </span>{
    <span class="hljs-keyword">if</span> (!id) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'SimpleFileDB#remove() requires an ID argument'</span>);
    }

    <span class="hljs-keyword">var</span>
    err,
    file = <span class="hljs-keyword">this</span>.dir.append(id + <span class="hljs-string">'.json'</span>);

    <span class="hljs-keyword">if</span> (file.isFile()) {
      file.remove();
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(id);
    }

    err = <span class="hljs-keyword">new</span> Errors.NotFoundError(<span class="hljs-string">'Could not find record with id "'</span> + id + <span class="hljs-string">'"'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(err);
  },

  uuid: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.nodeId === <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.nodeId === <span class="hljs-string">'number'</span>) {
      <span class="hljs-keyword">return</span> nodeUUID.v1({node: <span class="hljs-keyword">this</span>.nodeId});
    }
    <span class="hljs-keyword">return</span> nodeUUID.v1();
  }
});

JSONFileDatabase.create = U.factory(JSONFileDatabase.prototype);</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h2 id="utilities">Utilities</h2>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <h3 id="making-http-requests">Making HTTP Requests</h3>
<p>Enginemill exposes a thin wrapper around the venerable
<a href="https://github.com/request/request">request</a>
library to integrate Bluebird Promises into the API.</p>
<p>Here’s an example of making a request and either printing out the HTTP headers,
or reporting a failure.</p>
<pre><code class="lang-JS">enginemill.Request.get(<span class="hljs-string">'www.example.com'</span>).promise
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>{
    <span class="hljs-built_in">console</span>.log(response.headers);
  })
  .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
    <span class="hljs-built_in">console</span>.error(err.stack);
    process.exit(<span class="hljs-number">1</span>);
  });
</code></pre>
<p>If there are any errors in the process of making the HTTP request, or if any
errors are thrown inside the <code>printHeaders()</code> function, they will be caught
and passed to the handler passed into <code>.catch()</code>.</p>
<p>The <code>.then()</code> and <code>.catch()</code> methods of a Promise instance both return another
promise instance, so you can chain them like this:</p>
<pre><code class="lang-JS"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printHeaders</span>(<span class="hljs-params">response</span>) </span>{
  <span class="hljs-built_in">console</span>.log(response.headers);
  <span class="hljs-keyword">return</span> response;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printBody</span>(<span class="hljs-params">response</span>) </span>{
  <span class="hljs-built_in">console</span>.log(response.body);
  <span class="hljs-keyword">return</span> response;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printLineCount</span>(<span class="hljs-params">response</span>) </span>{
  <span class="hljs-keyword">var</span> count = respond.body.split(<span class="hljs-string">'\n'</span>).length;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Line Count: %s'</span>, count);
  <span class="hljs-keyword">return</span> response;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fail</span>(<span class="hljs-params">err</span>) </span>{
  <span class="hljs-built_in">console</span>.error(err.stack);
  process.exit(<span class="hljs-number">1</span>)
}

enginemill.Request.get(<span class="hljs-string">"www.example.com"</span>).promise
  .then(printHeaders)
  .then(printBody)
  .then(printLineCount)
  .catch(fail);
</code></pre>
<p>There are several methods you can use to make HTTP requests, each
corresponding to an HTTP request method. There is also one generic method
you can use for any HTTP request type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>enginemill.Request = {

  request: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">uri, opts, makeRequest</span>) </span>{
    makeRequest = makeRequest || REQ;
    <span class="hljs-keyword">var</span>
    req, promise, resolve, reject, params;

    promise = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">res, rej</span>) </span>{
      resolve = res;
      reject = rej;
    });

    params = REQ.initParams(uri, opts, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, res, body</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> reject(err);
      }

      <span class="hljs-built_in">Object</span>.defineProperties(res, {
        body: {
          enumerable : <span class="hljs-literal">true</span>,
          value      : body
        }
      });
      <span class="hljs-keyword">return</span> resolve(res);
    });

    params.followRedirect = params.followRedirect || <span class="hljs-literal">false</span>;
    params.encoding = <span class="hljs-keyword">typeof</span> params.encoding === <span class="hljs-string">'string'</span> ? params.encoding : <span class="hljs-literal">null</span>;
    req = makeRequest(params, params.callback);
    req.promise = promise;
    <span class="hljs-keyword">return</span> req;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <h4 id="options-for-http-requests">Options for HTTP requests</h4>
<p>A full list of options which can be passed into request methods.</p>
<p><strong>qs</strong> - An Object hash containing query string values to be appended to
the URL String before the request is sent.</p>
<pre><code class="lang-JS"><span class="hljs-comment">// Send "http://localhost:8080/pathname?foo=bar&amp;baz=true"</span>
enginemill.Request.get(<span class="hljs-string">'http://localhost:8080/pathname'</span>, {qs: {
  foo: <span class="hljs-string">'bar'</span>,
  baz: <span class="hljs-literal">true</span>
}});

<span class="hljs-comment">// Send "http://localhost:8080/pathname?foo[0]=a&amp;foo[1]=b&amp;foo[2]=c&amp;baz="</span>
enginemill.Request.get(<span class="hljs-string">'http://localhost:8080/pathname'</span>, {qs: {
  foo: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>],
  baz: <span class="hljs-literal">null</span>
}});
</code></pre>
<p><strong>headers</strong> - An Object hash defining HTTP headers to send (default: <code>{}</code>).</p>
<pre><code class="lang-JS"><span class="hljs-keyword">var</span> headers = {
  <span class="hljs-string">'user-agent'</span>: <span class="hljs-string">'Enginemill request library :-)'</span>,
  cookie: <span class="hljs-string">'foo=bar; baz=true'</span>
};

enginemill.Request.get(<span class="hljs-string">'http://localhost:8080/pathname'</span>, {headers: headers});
</code></pre>
<p>In most POST, PUT, and PATCH requests the “content-length” and
“content-type” headers will be set for you based on your use of <code>json</code>,
<code>form</code>, or <code>body</code>.</p>
<p><strong>encoding</strong> - A String or null indicating the encoding to use when
parsing the response. A null value will cause the HTTP body to be set as a
Buffer. A string like ‘utf8’ will cause the HTTP body to be set as a
String. (default: null)</p>
<p><strong>body</strong> - Buffer or String for PATCH, POST and PUT requests.</p>
<pre><code class="lang-JS"># Send a Buffer representing a String.
enginemill.Request.post(&#39;http://localhost:8080/pathname&#39;, {body: new Buffer(&#39;Hi server!&#39;)});
</code></pre>
<p>A String or Buffer will cause the ‘content-length’ header to be set
automatically, but not the ‘content-type’ header.</p>
<p><strong>form</strong> - An Object hash to send PATCH, POST and PUT requests with a
URL encoded string.</p>
<pre><code class="lang-JS"><span class="hljs-keyword">var</span> form = {
  email: <span class="hljs-string">'john@example.io'</span>,
  available: [<span class="hljs-string">'mon'</span>, <span class="hljs-string">'wed'</span>, <span class="hljs-string">'fri'</span>],
  after_hours: <span class="hljs-literal">false</span>
};

<span class="hljs-comment">// Send the URL encoded form data as</span>
<span class="hljs-comment">// "email=john%40example.io&amp;available[0]=mon&amp;available[1]=wed&amp;available[2]=fri&amp;after_hours=false".</span>
enginemill.Request.post(<span class="hljs-string">'http://localhost:8080/pathname'</span>, {form: form});
</code></pre>
<p>This will add ‘content-type:
application/x-www-form-urlencoded; charset=utf-8’ and ‘content-length’ headers.</p>
<p><strong>json</strong> - An Object hash to send PATCH, POST and PUT requests with a JSON
encoded string.</p>
<pre><code class="lang-JS"><span class="hljs-keyword">var</span> form = {
  email: <span class="hljs-string">'john@example.io'</span>,
  available: [<span class="hljs-string">'mon'</span>, <span class="hljs-string">'wed'</span>, <span class="hljs-string">'fri'</span>],
  after_hours: <span class="hljs-literal">false</span>
};

<span class="hljs-comment">// Send the JSON encoded data as:</span>
<span class="hljs-comment">// "{"email":"john@example.io","available":["mon","wed","fri"],"after_hours":false}".</span>
enginemill.Request.post(<span class="hljs-string">'http://localhost:8080/pathname'</span>, {json: form});
</code></pre>
<p>This will add ‘content-type:
application/json’, ‘accept: application/json’, and ‘content-length’ headers.</p>
<p><strong>followRedirect</strong> - A Boolean indicating that GET requests should
automatically follow HTTP 3xx responses as redirects (default: <code>false</code>).</p>
<p><strong>followAllRedirects</strong> - A Boolean indicating that <em>non</em> GET requests
should automatically follow HTTP 3xx responses as redirects
(default: <code>false</code>).</p>
<p><strong>maxRedirects</strong> - A Number indicating the maximum number of redirects to
follow (default: <code>10</code>). If this number is exceeded the request will
eventually fail with “Error: Exceeded maxRedirects”.</p>
<p><strong>strictSSL</strong> - Boolean if <code>true</code> the SSL certificate from the server must
be valid. <strong>Note:</strong> to use your own certificate authority, you need to
specify an agent that was created with that CA as an option.</p>
<p><strong>timeout</strong> - Integer indicating the number of milliseconds to wait for a
request to respond before aborting the request. If a request times out it
will raise an [Error: ETIMEDOUT] Error.</p>
<p><strong>auth</strong> - An Object hash containing values <code>username</code>, <code>password</code>, and
<code>sendImmediately</code> fields. See the <strong>HTTP Authentication</strong> section for more
information.</p>
<h4 id="enginemill-request-class-methods">enginemill.Request class methods</h4>
<p><strong>Note:</strong> When making a request the response body will be a Buffer by
default. You can change that by setting the encoding option on your request
to something other than null. ‘utf8’ for example, would be good for
setting an HTML document body to a String on the response.</p>

            </div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p><strong>.get(uri, opts)</strong> Send a request using the HTTP ‘GET’ method.</p>
<p>To send URL query parameters, you can just append them on the URL String like
this:</p>
<pre><code class="lang-JS">enginemill.Request.get(<span class="hljs-string">'http://localhost:8080/pathname?foo=bar'</span>);
</code></pre>
<p>Or, you can add the parameters using an Object hash assigned to <code>qs</code> instead
(which is usually a better idea than manipulating the strings yourself):</p>
<pre><code class="lang-JS">enginemill.Request.get(<span class="hljs-string">'http://localhost:8080/pathname'</span>, {qs: {foo: <span class="hljs-string">'bar'</span>})
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">uri, opts</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.request(uri, opts, REQ.get.bind(REQ));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p><strong>.post(uri, opts)</strong> Send a request using the HTTP ‘POST’ method.</p>
<p>You can send a buffer or string in the options:</p>
<pre><code class="lang-JS">enginemill.Request.post(<span class="hljs-string">'http://localhost:8080/pathname'</span>, {body: <span class="hljs-string">'hi'</span>});
</code></pre>
<p>You can send form data with an Object hash:</p>
<pre><code class="lang-JS">enginemill.Request.post(<span class="hljs-string">'http://localhost:8080/pathname'</span>, {form: {foo: <span class="hljs-string">'bar'</span>}});
</code></pre>
<p>which will encode the form Object as a URL encoded query String and set
the Content-Type header to <code>application/x-www-form-urlencoded</code>.</p>
<p>Sending JSON is easy too:</p>
<pre><code class="lang-JS">enginemill.Request.post(<span class="hljs-string">'http://localhost:8080/pathname'</span>, {json: {foo: <span class="hljs-string">'bar'</span>}});
</code></pre>
<p>The Content-Type header will be set to <code>application/json</code> and the response
body will be parsed as JSON.</p>
<p>If no options hash Object is passed into .post(), it will return a
FormData instance (see FormData below).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  post: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">uri, opts</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.request(uri, opts, REQ.post.bind(REQ));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p><strong>.put(uri, opts)</strong> Send a request using the HTTP ‘PUT’ method.</p>
<p>See the .post() docs above; the API is the same.</p>
<pre><code class="lang-JS">enginemill.Request.put(<span class="hljs-string">'http://localhost:8080/pathname'</span>, {form: {foo: <span class="hljs-string">'bar'</span>}});
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  put: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">uri, opts</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.request(uri, opts, REQ.put.bind(REQ));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p><strong>.patch(uri, opts)</strong> Send a request using the HTTP ‘PATCH’ method.</p>
<p>See the .post() docs above. The API is the same.</p>

            </div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <pre><code class="lang-JS">enginemill.Request.patch(<span class="hljs-string">'http://localhost:8080/pathname'</span>, {form: {foo: <span class="hljs-string">'bar'</span>}});
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  patch: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">uri, opts</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.request(uri, opts, REQ.patch.bind(REQ));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p><strong>.del(uri, opts)</strong> Send a request using the HTTP ‘DELETE’ method.</p>
<pre><code class="lang-JS">enginemill.Request.del(<span class="hljs-string">'http://localhost:8080/path/resource'</span>);
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  del: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">uri, opts</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.request(uri, opts, REQ.del.bind(REQ));
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <h4 id="http-authentication">HTTP Authentication</h4>
<p>Have a look at the Wikipedia article on
<a href="http://en.wikipedia.org/wiki/Basic_access_authentication">Basic Access Authentication</a>
if this concept is not familiar to you. With that said, the <code>enginemill.Request</code>
library includes an easy way of providing HTTP authentication credentials.</p>
<pre><code class="lang-JS"><span class="hljs-comment">// Send a basic authentication header.</span>
<span class="hljs-keyword">var</span> auth = {
  username: <span class="hljs-string">'john'</span>,
  password: <span class="hljs-string">'firesale'</span>
};

enginemill.Request.get(<span class="hljs-string">'http://localhost:8080/pathname'</span>, {auth: auth});

<span class="hljs-comment">// Retry with a basic authentication header, after receiving a 401 response</span>
<span class="hljs-comment">// from the server.</span>
<span class="hljs-keyword">var</span> auth = {
  username: <span class="hljs-string">'john'</span>,
  password: <span class="hljs-string">'firesale'</span>,
  sendImmediately: <span class="hljs-literal">false</span>
};

enginemill.Request.get(<span class="hljs-string">'http://localhost:8080/pathname'</span>, {auth: auth});
</code></pre>
<p>The <code>sendImmediately</code> parameter defaults to <code>true</code>, which causes the basic
authentication header to be sent on the first request, which is usualy
what you want. If you explicitly set <code>sendImmediately</code> to <code>false</code> then the
library will retry the request with a proper authentication header after
receiving a 401 response from the server, which must include a
‘WWW-Authenticate’ header indicating the required authentication method.</p>
<p>Digest authentication is supported, but it only works with <code>sendImmediately</code>
set to false; otherwise the library will send the basic authentication header
on the initial request, which will probably cause the request to fail when the
server is expecting digest authentication.</p>
<h4 id="request-instances">Request Instances</h4>
<p>Each <code>enginemill.Request</code> method returns a Request instance. <em>Remember:</em> A
Request instance is a Node.js Stream object, and has all the properties and
methods you would expect a Writable Stream to have.</p>
<h4 id="request-instance-properties">Request Instance properties</h4>
<ul>
<li><strong>promise</strong>  - A <a href="./promises">Promise</a> instance for the HTTP Response object.</li>
<li><strong>readable</strong> - Boolean which is true if the Request Stream is still readable.</li>
<li><strong>writable</strong> - Boolean which is true if the Request Stream is still writable.</li>
<li><strong>method</strong>   - String like ‘GET’ indicating the HTTP method.</li>
<li><strong>headers</strong>  - An dictionary Object of HTTP headers sent.</li>
<li><strong>agent</strong>    - The Node.js HTTP Agent object used.</li>
<li><strong>uri</strong>      - A Node.js URL Object structured like this:<ul>
<li><strong>uri.href</strong>     - The full URL String, like ‘<a href="http://www.example.com">http://www.example.com</a>‘.</li>
<li><strong>uri.protocol</strong> - The protocol String, like ‘http’ or ‘https’.</li>
<li><strong>uri.auth</strong>     - The authorization String, like ‘username:password’.</li>
<li><strong>uri.host</strong>     - The full host string, including the port, like ‘www.example.com:8080’.</li>
<li><strong>uri.hostname</strong> - Only the host name, not the port, like ‘www.example.com’.</li>
<li><strong>uri.port</strong>     - The port number String of the URI, like ‘8080’.</li>
<li><strong>uri.path</strong>     - The path String with the query String, like ‘/customers?id=2’.</li>
<li><strong>uri.pathname</strong> - Only the path String, like ‘/customers’.</li>
<li><strong>uri.search</strong>   - Query String including the leading ‘?’.</li>
<li><strong>uri.query</strong>    - Only the query String, like ‘id=2’.</li>
<li><strong>uri.hash</strong>     - The fragment String including the leading ‘#’.</li>
</ul>
</li>
</ul>
<h4 id="request-instance-methods">Request Instance Methods</h4>
<ul>
<li><strong>form()</strong> - Returns a form object which can be used to send various kinds
of HTTP form data. See the <strong>HTTP Request FormData</strong> section for more
information.</li>
</ul>
<h4 id="response-instances">Response Instances</h4>
<p>Each <code>enginemill.Request</code> method returns a Request instance with a <code>promise</code>
attribute. That promise will resolve to a Response instance. <em>Remember:</em> A
Response instance is a Node.js Stream object, and has all the properties and
methods you would expect a Readable Stream to have.</p>
<h4 id="request-instance-properties">Request Instance properties</h4>
<ul>
<li><strong>httpVersion</strong> - HTTP version String.</li>
<li><strong>httpVersionMajor</strong> - HTTP major version Number (easier to detect than httpVersion String).</li>
<li><strong>httpVersionMinor</strong> - HTTP minor version Number (easier to detect than httpVersion String).</li>
<li><strong>headers</strong> - Object hash of HTTP response headers.</li>
<li><strong>statusCode</strong> - The HTTP status code of the response. See the <a href="http://tools.ietf.org/html/rfc2616#section-10">original RFC document</a> as an authoritative reference.</li>
<li><strong>body</strong> - The HTTP response body as a Buffer by default. If you would like a String returned, set the encoding option on your request to ‘utf8’.</li>
<li><strong>request</strong> - The Request instance that resulted in this Response instance.</li>
</ul>
<h4 id="http-request-formdata">HTTP Request FormData</h4>
<p>Send multipart file data by creating a form object with the Request#form() method:</p>
<pre><code class="lang-JS"><span class="hljs-comment">// No .body, .form, or .json options are required.</span>
<span class="hljs-keyword">var</span> form = enginemill.Request.post(<span class="hljs-string">'http://localhost:8080/pathname'</span>).form();
form.append(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>);
form.append(<span class="hljs-string">'a_file'</span>, enginemill.filepath.create(<span class="hljs-string">'./my_pic.jpg'</span>).newReadStream());
form.append(<span class="hljs-string">'a_buffer'</span>, <span class="hljs-keyword">new</span> Buffer(<span class="hljs-string">'foobarbaz'</span>));
</code></pre>

            </div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <h3 id="enginemill-readjson">enginemill.readJSON</h3>
<p>A utility function used by Enginemill to read JSON files, but available
on the public API as well.</p>
<h4 id="arguments">Arguments</h4>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>path</strong></td>
<td><em>FilePath instance</em> The path to the JSON file to load.</td>
</tr>
</tbody>
</table>
<p><strong>Returns</strong>:</p>
<ul>
<li>A Promise for parsed JSON file if it exists.</li>
<li>If it does not exist then returns a Promise for null.</li>
<li>If there is a JSON syntax error detected a JSONParseError is
returned via rejection.</li>
<li>If the given path is not a file an Error is
passed via rejection.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>enginemill.readJSON = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>{
  <span class="hljs-keyword">var</span> path = args.path;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseJSON</span>(<span class="hljs-params">text</span>) </span>{
    <span class="hljs-keyword">var</span> err, data;
    <span class="hljs-keyword">try</span> {
      data = <span class="hljs-built_in">JSON</span>.parse(text +<span class="hljs-string">''</span>);
    } <span class="hljs-keyword">catch</span> (e) {
      err = <span class="hljs-keyword">new</span> Errors.JSONParseError(<span class="hljs-string">'JSON SyntaxError: '</span>+ e.message +<span class="hljs-string">' in '</span>+ path);
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(err);
    }
    <span class="hljs-keyword">return</span> data;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setValues</span>(<span class="hljs-params">data</span>) </span>{
    <span class="hljs-keyword">return</span> U.extend(<span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>), data || <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>));
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">catchFileReadError</span>(<span class="hljs-params">err</span>) </span>{
    <span class="hljs-keyword">var</span> newError = <span class="hljs-keyword">new</span> Errors.OperationalError(<span class="hljs-string">'Unexpected JSON read Error: '</span>+ err.message);
    newError.code = err.code;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(newError);
  }

  <span class="hljs-keyword">if</span> (path.exists() &amp;&amp; path.isFile()) {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(path.read())
      .then(parseJSON, catchFileReadError)
      .then(setValues);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!path.exists()) {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-literal">null</span>);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(
    <span class="hljs-keyword">new</span> Errors.OperationalError(<span class="hljs-string">'The FilePath is not a file: '</span>+ path));
};</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <h3 id="enginemill-parsecommandlineoptions">enginemill.parseCommandLineOptions</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>enginemill.parseCommandLineOptions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>{
  <span class="hljs-keyword">var</span> options = Yargs
    .reset()
    .usage(args.usageString)
    .help(<span class="hljs-string">'help'</span>, args.helpString);

  <span class="hljs-keyword">if</span> (args.options &amp;&amp; <span class="hljs-keyword">typeof</span> args.options === <span class="hljs-string">'object'</span>) {
    <span class="hljs-built_in">Object</span>.keys(args.options).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) </span>{
      <span class="hljs-keyword">var</span> conf = args.options[key];
      options = options.option(key, conf);
    });
  }

  <span class="hljs-keyword">return</span> options.parse(args.argv || process.argv);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <h2 id="store-query-presenter-architecture">Store/Query/Presenter Architecture</h2>

            </div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Enginemill holds a string opinion that Command/Query
Responsibility Segregation (<a href="http://martinfowler.com/bliki/CQRS.html">CQRS</a>)
is essential to allow developers to reason about otherwise complex systems.
Strict adherence to CQRS should lead to a Store/Query/Presenter
architecture as suggested by Enginemill.</p>
<h3 id="message-based-communication">Message Based Communication</h3>
<p>Having a built in message based communication system makes Store/Query/
Presenter possible. See <code>enginemill.oddcast</code> for more info.</p>
<p>Examples:</p>
<h4 id="broadcast-channel">Broadcast Channel</h4>
<p>A Broadcast Channel broadcasts events throughout the system to anyone who
might be listening.</p>
<pre><code class="lang-JS"><span class="hljs-keyword">var</span> oddcast = <span class="hljs-built_in">require</span>(<span class="hljs-string">'oddcast'</span>);
<span class="hljs-keyword">var</span> transport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'my-transport'</span>);
<span class="hljs-keyword">var</span> events = oddcast.eventChannel();
events.use({role: <span class="hljs-string">'store'</span>}, transport({
    url: <span class="hljs-string">'http://mypubsub.io/channel/1'</span>
  }));

events.observe({role: <span class="hljs-string">'store'</span>, op: <span class="hljs-string">'write'</span>, type: <span class="hljs-string">'video'</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>{
  writeIndexRecord(args.entity.key, args.entity);
});
</code></pre>
<p>And in some other code, somewhere else …</p>
<pre><code class="lang-JS"><span class="hljs-keyword">var</span> oddcast = <span class="hljs-built_in">require</span>(<span class="hljs-string">'oddcast'</span>);
<span class="hljs-keyword">var</span> transport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'my-transport'</span>);
<span class="hljs-keyword">var</span> events = oddcast.eventChannel();
events.use({role:<span class="hljs-string">'store'</span>}, transport({
    url: <span class="hljs-string">'http://mypubsub.io/channel/1'</span>
  }));

<span class="hljs-comment">// When a record is saved to the datastore, we broadcast it.</span>
events.broadcast({
    role: <span class="hljs-string">'store'</span>,
    type: entity.type,
    op: <span class="hljs-string">'write'</span>,
    entity: entity
  });
</code></pre>
<h4 id="command-channel">Command Channel</h4>
<p>A Command Channel is used for directed messages, with the expectation that
the receiving component will take a specified action. The underlying
transport under a command channel will usually be a message queue.</p>
<pre><code class="lang-JS"><span class="hljs-keyword">var</span> oddcast = <span class="hljs-built_in">require</span>(<span class="hljs-string">'oddcast'</span>);
<span class="hljs-keyword">var</span> transport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'my-transport'</span>);
<span class="hljs-keyword">var</span> commands = oddcast.commandChannel();
commands.use({role: <span class="hljs-string">'ingest'</span>}, transport({
    url: <span class="hljs-string">'http://myqueue.io/queue/1'</span>
  }));

commands.receive({role: <span class="hljs-string">'ingest'</span>, type: <span class="hljs-string">'video'</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>{
  <span class="hljs-keyword">var</span> entity = transformItem(args.item);
  <span class="hljs-keyword">var</span> promise = saveEntity(entity).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-comment">// We return true so the queue knows this message has been processed.</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  })
  .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
    log.error(err);
    <span class="hljs-comment">// We return false so the queue will keep this message and try</span>
    <span class="hljs-comment">// sending it again.</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  });

  <span class="hljs-keyword">return</span> promise;
});
</code></pre>
<p>And in some other code, somewhere else …</p>
<pre><code class="lang-JS"><span class="hljs-keyword">var</span> oddcast = <span class="hljs-built_in">require</span>(<span class="hljs-string">'oddcast'</span>);
<span class="hljs-keyword">var</span> transport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'my-transport'</span>);
<span class="hljs-keyword">var</span> commands = oddcast.commandChannel();
commands.use({role: <span class="hljs-string">'ingest'</span>}, transport({
    url: <span class="hljs-string">'http://myqueue.io/queue/1'</span>
  }));

<span class="hljs-comment">// Fetch data from a remote API and queue it up for the store</span>
<span class="hljs-comment">// by sending off a "job" for each one.</span>
items.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{
  commands.send({role: <span class="hljs-string">'ingest'</span>, type: item.type, item: item});
});
</code></pre>
<h4 id="request-channel">Request Channel</h4>
<p>A Request Channel is used when you know who has the data you need, and
would like to request it from them.</p>
<pre><code class="lang-JS"><span class="hljs-keyword">var</span> oddcast = <span class="hljs-built_in">require</span>(<span class="hljs-string">'oddcast'</span>);
<span class="hljs-keyword">var</span> transport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'my-transport'</span>);
<span class="hljs-keyword">var</span> rchannel = oddcast.requestChannel();
rchannel.use({role: <span class="hljs-string">'views'</span>}, transport({
    host: <span class="hljs-string">'0.0.0.0'</span>,
    port: <span class="hljs-number">8080</span>
  }));

rchannel.respond({view: <span class="hljs-string">'homePage'</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> {
    featuredVideo: getFeaturedVideo(),
    recentlyAdded: getRecentlyAdded(),
    season: getShowSeason()
  };
});
</code></pre>
<p>// And in some other code, somewhere else …</p>
<pre><code class="lang-JS"><span class="hljs-keyword">var</span> oddcast = <span class="hljs-built_in">require</span>(<span class="hljs-string">'oddcast'</span>);
<span class="hljs-keyword">var</span> transport = <span class="hljs-built_in">require</span>(<span class="hljs-string">'my-transport'</span>);
<span class="hljs-keyword">var</span> rchannel = oddcast.requestChannel();
rchannel.use({role: <span class="hljs-string">'views'</span>}, transport({
    url: <span class="hljs-string">'http://mymicroservice.io:8080/endpoint/1'</span>
  }));

<span class="hljs-comment">// Respond to an HTTP request by querying your view.</span>
Router.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
  rchannel
    .request({role: views, view: <span class="hljs-string">'homePage'</span>})
    .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">viewData</span>) </span>{
      res.render(<span class="hljs-string">'homePage.html'</span>, viewData);
    });
});
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>
sendDebug(<span class="hljs-string">'The Enginemill module has loaded.'</span>);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
